---
title: "Betfair_UKPolitics_Preprocessing"
output:
  html_document:
    keep_md: yes
    toc: yes
---

### About

Here I explain how I get (and clean) the data from all Betfair's "UK Politics" Markets, i.e. all the sub-branches of [this page](https://www.betfair.com/exchange/?nodeId=MENU:2707982).

### Getting List of Betfair UK Politics Markets

**Get_list_of_Betfair_UKPolitics_Markets.R** recursively retrieves a list of all the market that [this page](http://www.betfair.com/exchange/?nodeId=MENU:2707982) is a parent or (great)grandparent of.  
As the markets don't appear (or disappear) everyday, I only run the following (commented out) chunk once or twice a week.
```{r Get_list_of_Markets}
# root_dir <- getwd()
# setwd("../../Codes/Preprocessing Data/")
# source("Get_list_of_Betfair_UKPolitics_Markets.R")
# setwd(root_dir)
```

The output file looks like:
```{r Markets Sample}
head(read.csv("../../raw_data/list_of_Betfair_UKPolitics_Markets.txt", 
              header = FALSE))
```

### Getting Odds

A c# project goes through all markets, parses HTMLs, extracts useful bits, and appends them to the existing **Betfair_UKPolitics_odds.csv** file. 
To Create two of the class in this project, I used [Fiddler](http://www.telerik.com/fiddler) and [http://json2csharp.com/](http://json2csharp.com/).

For each outcome of each market, the code returns odds and amount to bet for up to 3 (betfair's limit) values for back and up to 3 values for lay. 
For each Market, the code also returns total matched value, i.e. the sum of all bids and asks that have successfully been matched.

the output looks like:
```{r Raw Data Sample}
head(read.table("../../raw_data/Betfair_UKPolitics_odds.csv", sep = "\t"))
```

### Cleaning Market Names

Some Markets had slightly different names when I started collecting data (e.g. *2015 UK General Election - Overall Majority* used to *Next UK General Election - Overall Majority*) 
**Clean_UKPolitics_Odds_Data_Market_Names_Tests_Before_Cleaning.R** runs some tests to find them.

**Market_Names_Replacements.csv** contains a list of "bad" names (first column) to be replaced by "good" ones (second column). It looks like:

```{r Market Names Replacements Sample}
head(read.table("../../raw_data/Market_Names_Replacements.csv", sep = "\t"))
```

**Clean_UKPolitics_Odds_Data.R** reads **Betfair_UKPolitics_odds.csv** and replaces the bad names with the good ones according to **Market_Names_Replacements.csv**

```{r Cleaning Market Names}
root_dir <- getwd()
setwd("../../Codes/Preprocessing Data/")
source("Clean_UKPolitics_Odds_Data.R")
setwd(root_dir)
```

### Reshaping Data

**Clean_UKPolitics_Odds_Data.R** -for each Market/outcome/time combination- finds the best available odds (both back and lay); and saves them (and other relevenat information) in **Betfair_UKPolitics_Odds_History.csv**.

### Output 

Done! **Betfair_UKPolitics_Odds_History.csv** is good to go. it has 6 columns:

- Market 
- Outcome
- Date_char
- Back
- Lay
- Matched

and looks like

```{r Processed Data Sample}
head(read.csv("../../Betfair_UKPolitics_Odds_History.csv", sep = ","))
```
